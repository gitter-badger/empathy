<?php
date_default_timezone_set('Europe/London');
//header("Cache-Control: no-cache, must-revalidate"); // HTTP/1.1
//header("Expires: Mon, 26 Jul 1997 05:00:00 GMT"); // Date in the past

array_push($module, "empathy");
array_push($moduleIsDynamic, 0);

require(DOC_ROOT."/empathy/include/Controller.php");
require(DOC_ROOT."/empathy/include/SmartyPresenter.php");

$uri = processRequest($module);

if((!(isset($_GET['module']))) || (!(in_array($_GET['module'], $module))))
{
  $moduleIndex = DEF_MOD;
  $_GET['module'] = $module[$moduleIndex];
}
else
{
  $i = 0;
  while($_GET['module'] != $module[$i])
  {
    $i++;
  }
  $moduleIndex = $i;
}

if(!(isset($_GET['class'])))
{
  $_GET['class'] = $_GET['module'];
}
$controllerName = $_GET['class'];


if($_GET['module'] == "empathy")
{
  $innerPath = "empathy/";
}
else
{
  $innerPath = "";
}
define("INNER_PATH", $innerPath);

$controllerPath = DOC_ROOT."/".INNER_PATH."application/".$_GET['module']."/$controllerName.php";
$controllerError = 0;
if(!is_file($controllerPath))
{
  $_GET['event'] = $_GET['class'];
  $_GET['class'] = $_GET['module'];
  $controllerName = $_GET['module'];
  $controllerError = 1;
  $controllerPath = DOC_ROOT."/".INNER_PATH."application/".$_GET['module']."/$controllerName.php";
}


if(is_file($controllerPath))
{
  require($controllerPath);
}


if(!class_exists($controllerName) && $controllerError == 0)
{
  $controllerError = 2; 
  $controllerPath = DOC_ROOT."/empathy/include/Controller.php";
  $controllerName = "Controller";
}

if(!(isset($_GET['event'])))
{
  $_GET['event'] = "default_event";
}

$controller = new $controllerName($controllerError);

$controller->$_GET['event']();

//$presenter->smarty->load_filter('output', 'png_image');
$controller->initDisplay();


function incPlugin($name)
{
  require(DOC_ROOT."/include/plugin/empathy.$name.php");
}

function processRequest($module)
{
  $processed_uri = "";
  
  // recevive request
  $full_uri = $_SERVER['HTTP_HOST'].$_SERVER['REQUEST_URI'];
  $toRemove = WEB_ROOT.PUBLIC_DIR;
  $uri_string = substr($full_uri, strlen($toRemove));
  $uri_arr = explode("/", $uri_string);

  #incPlugin("force_www");
    
  // form processed section array
  $htmlMode = 0;
  $i = 0;
  $j = 0;
  $l = 1; // location of potential 'html mode' flag
  while($i < sizeof($uri_arr))
  {
    if($i == 1)
    {
      for($k = 0; $k < sizeof($module); $k++)
      {
	if($uri_arr[$i] == $module[$k])
	{
	  $_GET['module'] = $module[$k];
	  $l++;
	}
      }
    }
    elseif($i == 2 && $uri_arr[$i] != "")
    {
      $_GET['class'] = $uri_arr[$i];
    }
    elseif($i == 3 && $uri_arr[$i] != "")
    {
      $_GET['event'] = $uri_arr[$i];
    }

    
    /* html mode detection */
    if($i == $l && $uri_arr[$i] == "html")
    {
      $htmlMode = 1;
    }                
    elseif($uri_arr[$i] != "" && (!(in_array($uri_arr[$i], $module))))
    {
      $processed_uri[$j] = $uri_arr[$i];
      $j++;
    }
    $i++;
  }

  define('HTML_ONLY', $htmlMode);      
  
  return $processed_uri;
}

function dynamicSection($section, $uri)
{
  // code to assert correct section path - else throw 404

  if(sizeof($uri) > 1)
  {
    $section_index = (sizeof($uri) - 1);
    if(is_numeric($uri[$section_index]))
    {
      $_GET['id'] = $uri[$section_index--];
    }
    $section_uri = $uri[$section_index];		       
  }

  if(!(isset($section_uri)))
  {
      $section_uri = "news";
  }  
  
  $rows = $section->getURIData();
  for($i = 0; $i < sizeof($rows); $i++)
  {
    if($rows[$i]['friendly_url'] != NULL)
    {
      $comp = str_replace(" ", "", strtolower($rows[$i]['friendly_url']));
    }
    else
    {
      $comp = str_replace(" ", "", strtolower($rows[$i]['label']));
    }
    if($comp == $section_uri)
    {
      $_GET['section'] = $rows[$i]['id'];
    }
  }
  
  if(isset($_GET['section']))
  {
    $section->getItem($_GET['section']);
  }

  // section id is not set / found
  if(!(is_numeric($section->id)))
  {
    header("Location: http://".WEB_ROOT);
    exit();
  }
  
  if(isset($_GET['id']))
  {
    $section->layout = REGULAR_LAYOUT;
  }
    
  if($section->layout == "")
  {
    $end_uri = $section->buildURL($section->getFirstChild($section->id));
    $j = (sizeof($end_uri) - 1);
    $k = 0;
    $full_url = "http://".WEB_ROOT."/";
    while($j >= $k)
    {
      $full_url .= str_replace(" ", "", strtolower($end_uri[$j]))."/";
      $j--;    
    }
    header("Location: $full_url");
    exit();
  }
  else
  {
    $specialised = array();
    
    if(in_array($section->id, $specialised))
    {
      $controllerName = "layout".$section->id;
    }
    else
    {
      $controllerName = "layout".$section->layout;
    }   
  }
  return $controllerName;
}
?>


